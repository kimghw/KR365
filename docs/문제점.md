DCR OAuth 인증 시스템의 현재 문제점 요약
현재 DCR OAuth 인증 시스템은 설계 단계에서 RFC 7591 표준 준수와 이론적 완전성을 우선시한 결과, 실제 운영 환경에서 세 가지 주요 문제를 발생시키고 있습니다.
첫 번째 문제: 불필요한 NULL 상태 관리
클라이언트 등록 시 azure_object_id를 NULL로 저장하는 중간 단계가 존재하지만, 이는 실무적으로 거의 활용되지 않는 불필요한 복잡성입니다. DCRService.register_client 메서드는 NULL 상태의 클라이언트를 재사용하려는 로직을 포함하고 있으나, 실제로는 mcp_session_id 기반 재사용이 우선적으로 작동하기 때문에 이 로직이 실행될 가능성이 극히 낮습니다. 정상적인 인증 플로우에서는 클라이언트가 등록된 후 몇 초 내에 로그인이 완료되어 azure_object_id가 채워지므로, NULL 상태는 단순히 임시 상태일 뿐입니다. 이러한 중간 단계는 코드의 복잡도를 증가시키고 유지보수 비용을 높이지만, 실질적인 가치는 제공하지 못하고 있습니다.
두 번째 문제: 클라이언트 ID 동기화 불일치
가장 심각한 문제는 클라이언트 등록을 건너뛰거나 순서가 잘못된 경우 발생하는 클라이언트 ID 불일치입니다. Claude.ai나 ChatGPT와 같은 플랫폼이 POST /oauth/register 단계를 생략하고 바로 GET /oauth/authorize를 호출하면, oauth_authorize_handler는 존재하지 않는 client_id를 처리하기 위해 새로운 임시 클라이언트를 생성합니다. 이후 Azure AD 콜백에서 이 임시 client_id와 azure_object_id가 연결되지만, 플랫폼이 실제로 사용하려는 client_id와 서버가 생성한 client_id가 서로 다르게 됩니다. 결과적으로 POST /oauth/token 단계에서 플랫폼이 원래 의도한 client_id로 토큰을 요청하면 authorization_code 검증이 실패하여 인증 전체가 실패합니다. 이는 간헐적이지만 치명적인 오류를 발생시키며, 사용자 경험을 크게 저하시킵니다.
세 번째 문제: 클라이언트 중복 생성 및 관리 혼란
동일한 사용자가 여러 세션에서 접속하거나 여러 디바이스에서 동시에 접속할 때, 시스템은 각 접속마다 새로운 클라이언트를 생성합니다. DCRService.update_client_user 메서드는 단순히 전달받은 dcr_client_id의 azure_object_id를 업데이트할 뿐, 동일한 사용자의 기존 클라이언트가 이미 존재하는지 확인하지 않습니다. 이로 인해 dcr_clients 테이블에 동일한 azure_object_id를 가진 여러 클라이언트가 중복 생성되며, 각 클라이언트마다 별도의 토큰이 발급되어 토큰 관리가 복잡해집니다. 또한 사용자별 접속 이력 추적과 보안 감사가 어려워지며, 데이터베이스 용량도 불필요하게 증가합니다.
근본 원인 분석
이러한 문제들의 근본 원인은 클라이언트 생명주기 관리와 사용자 연결 로직이 분리되어 있으면서도, 두 프로세스 간의 조율 메커니즘이 부재하다는 점입니다. 클라이언트는 등록 시점에 생성되고, 사용자는 로그인 시점에 연결되지만, 이 두 시점 사이의 간격에서 발생할 수 있는 다양한 예외 상황에 대한 처리가 충분하지 않습니다. 특히 Azure AD 콜백 처리 단계에서 기존 클라이언트와의 통합 로직이 없기 때문에, 시스템은 매번 새로운 클라이언트를 생성하거나 잘못된 클라이언트를 사용하게 됩니다.
영향 범위
이러한 문제는 운영 환경에서 다음과 같은 실질적인 영향을 미칩니다. 사용자가 간헐적으로 인증 실패를 경험하며 재시도해야 하는 불편함이 발생하고, 데이터베이스에 사용되지 않는 고아 클라이언트 레코드가 지속적으로 축적되어 성능 저하가 우려됩니다. 또한 관리자가 특정 사용자의 클라이언트와 토큰을 추적하기 어려워 보안 사고 대응이 지연될 수 있으며, 플랫폼별로 인증 성공률이 달라져 서비스 품질의 일관성이 보장되지 않습니다.
요약하면, 현재 시스템은 이론적으로는 표준을 준수하고 있으나 실무적으로는 클라이언트 ID 동기화 실패와 중복 생성 문제로 인해 안정적인 서비스 운영에 장애가 되고 있습니다. Azure AD 콜백 처리 시점에서 기존 클라이언트 통합 로직을 추가하고, NULL 상태 관리를 단순화하는 것이 가장 시급한 개선 과제입니다.