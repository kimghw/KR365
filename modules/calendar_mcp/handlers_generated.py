"""
Calendar Management Service
MCP Protocol Handlers - Auto-generated from tool_config.yaml
Generated at: 2025-11-11T17:29:52.773464
Source config: modules/calendar_mcp/tool_config.yaml

DO NOT EDIT THIS FILE DIRECTLY
Modify tool_config.yaml and regenerate using:
python scripts/generate_handlers.py --config modules/calendar_mcp/tool_config.yaml
"""

import json
from typing import Any, Dict, List, Optional
from mcp.types import Tool, TextContent, Prompt, PromptArgument, PromptMessage

from infra.core.logger import get_logger
from infra.core.tool_registry import ToolRegistry, ToolConfig
from .calendar_handler import CalendarHandler
from .schemas import (    ListEventsRequest,    ListEventsResponse,    CreateEventRequest,    CreateEventResponse,    UpdateEventRequest,    UpdateEventResponse,    DeleteEventRequest,    DeleteEventResponse,    GetEventRequest,    GetEventResponse,)
logger = get_logger(__name__)


class CalendarHandlers:
    """Calendar Management Service MCP Protocol Handlers"""

    def __init__(self):
        """Initialize handlers with tools instance and registry"""
        self.calendar_handler = CalendarHandler()
        self.registry = ToolRegistry()
        self._register_tools()
        logger.info("âœ… CalendarHandlers initialized with 5 tools")

    def _register_tools(self):
        """Register all tools in the registry"""
        # calendar_list_events: ìº˜ë¦°ë” ì´ë²¤íŠ¸ ëª©ë¡ì„ ì¡°íšŒí•©ë‹ˆë‹¤....
        self.registry.register(
            ToolConfig(
                name="calendar_list_events",
                description="ìº˜ë¦°ë” ì´ë²¤íŠ¸ ëª©ë¡ì„ ì¡°íšŒí•©ë‹ˆë‹¤.",                request_class=ListEventsRequest,                response_class=ListEventsResponse,                method=self.calendar_handler.list_events,                auth_required=True,                auth_field="user_id",                parameters=[{"description": "\uc0ac\uc6a9\uc790 ID", "name": "user_id", "required": True, "type": "string"}, {"description": "\uc2dc\uc791 \uc2dc\uac04 (ISO 8601 \ud615\uc2dd, \uc608: 2025-01-15T00:00:00)", "name": "start_datetime", "required": False, "type": "string"}, {"description": "\uc885\ub8cc \uc2dc\uac04 (ISO 8601 \ud615\uc2dd, \uc608: 2025-01-15T23:59:59)", "name": "end_datetime", "required": False, "type": "string"}, {"default": 100, "description": "\ucd5c\ub300 \uacb0\uacfc \uc218", "name": "max_results", "required": False, "type": "integer"}],            )
        )
        # calendar_create_event: ìƒˆ ìº˜ë¦°ë” ì´ë²¤íŠ¸ë¥¼ ìƒì„±í•©ë‹ˆë‹¤....
        self.registry.register(
            ToolConfig(
                name="calendar_create_event",
                description="ìƒˆ ìº˜ë¦°ë” ì´ë²¤íŠ¸ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.",                request_class=CreateEventRequest,                response_class=CreateEventResponse,                method=self.calendar_handler.create_event,                auth_required=True,                auth_field="user_id",                parameters=[{"description": "\uc0ac\uc6a9\uc790 ID", "name": "user_id", "required": True, "type": "string"}, {"description": "\uc774\ubca4\ud2b8 \uc81c\ubaa9", "name": "subject", "required": True, "type": "string"}, {"description": "\uc2dc\uc791 \uc2dc\uac04 (ISO 8601 \ud615\uc2dd)", "name": "start_datetime", "required": True, "type": "string"}, {"description": "\uc885\ub8cc \uc2dc\uac04 (ISO 8601 \ud615\uc2dd)", "name": "end_datetime", "required": True, "type": "string"}, {"description": "\uc774\ubca4\ud2b8 \ub0b4\uc6a9", "name": "body_content", "required": False, "type": "string"}, {"description": "\uc774\ubca4\ud2b8 \uc704\uce58", "name": "location", "required": False, "type": "string"}],            )
        )
        # calendar_update_event: ê¸°ì¡´ ìº˜ë¦°ë” ì´ë²¤íŠ¸ë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤....
        self.registry.register(
            ToolConfig(
                name="calendar_update_event",
                description="ê¸°ì¡´ ìº˜ë¦°ë” ì´ë²¤íŠ¸ë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.",                request_class=UpdateEventRequest,                response_class=UpdateEventResponse,                method=self.calendar_handler.update_event,                auth_required=True,                auth_field="user_id",                parameters=[{"description": "\uc0ac\uc6a9\uc790 ID", "name": "user_id", "required": True, "type": "string"}, {"description": "\uc774\ubca4\ud2b8 ID", "name": "event_id", "required": True, "type": "string"}, {"description": "\uc774\ubca4\ud2b8 \uc81c\ubaa9", "name": "subject", "required": False, "type": "string"}, {"description": "\uc2dc\uc791 \uc2dc\uac04 (ISO 8601 \ud615\uc2dd)", "name": "start_datetime", "required": False, "type": "string"}, {"description": "\uc885\ub8cc \uc2dc\uac04 (ISO 8601 \ud615\uc2dd)", "name": "end_datetime", "required": False, "type": "string"}, {"description": "\uc774\ubca4\ud2b8 \ub0b4\uc6a9", "name": "body_content", "required": False, "type": "string"}, {"description": "\uc774\ubca4\ud2b8 \uc704\uce58", "name": "location", "required": False, "type": "string"}],            )
        )
        # calendar_delete_event: ìº˜ë¦°ë” ì´ë²¤íŠ¸ë¥¼ ì‚­ì œí•©ë‹ˆë‹¤....
        self.registry.register(
            ToolConfig(
                name="calendar_delete_event",
                description="ìº˜ë¦°ë” ì´ë²¤íŠ¸ë¥¼ ì‚­ì œí•©ë‹ˆë‹¤.",                request_class=DeleteEventRequest,                response_class=DeleteEventResponse,                method=self.calendar_handler.delete_event,                auth_required=True,                auth_field="user_id",                parameters=[{"description": "\uc0ac\uc6a9\uc790 ID", "name": "user_id", "required": True, "type": "string"}, {"description": "\uc774\ubca4\ud2b8 ID", "name": "event_id", "required": True, "type": "string"}],            )
        )
        # calendar_get_event: íŠ¹ì • ìº˜ë¦°ë” ì´ë²¤íŠ¸ì˜ ìƒì„¸ ì •ë³´ë¥¼ ì¡°íšŒí•©ë‹ˆë‹¤....
        self.registry.register(
            ToolConfig(
                name="calendar_get_event",
                description="íŠ¹ì • ìº˜ë¦°ë” ì´ë²¤íŠ¸ì˜ ìƒì„¸ ì •ë³´ë¥¼ ì¡°íšŒí•©ë‹ˆë‹¤.",                request_class=GetEventRequest,                response_class=GetEventResponse,                method=self.calendar_handler.get_event,                auth_required=True,                auth_field="user_id",                parameters=[{"description": "\uc0ac\uc6a9\uc790 ID", "name": "user_id", "required": True, "type": "string"}, {"description": "\uc774\ubca4\ud2b8 ID", "name": "event_id", "required": True, "type": "string"}],            )
        )

    # ========================================================================
    # MCP Protocol: list_tools
    # ========================================================================

    async def handle_list_tools(self) -> List[Tool]:
        """List available MCP tools"""
        logger.info("ğŸ”§ [MCP Handler] list_tools() called")
        return self.registry.list_tools()

    # ========================================================================
    # MCP Protocol: call_tool
    # ========================================================================

    async def handle_call_tool(
        self,
        name: str,
        arguments: Dict[str, Any],
        authenticated_user_id: Optional[str] = None
    ) -> List[TextContent]:
        """Handle MCP tool calls"""
        logger.info(f"ğŸ”¨ [MCP Handler] call_tool({name}) with args: {arguments}")

        try:            # ì¸ì¦ ê¸°ë°˜ user_id ê°•ì œ ì ìš© (ê²€ìƒ‰ ê³„ì—´ íˆ´ì—ë§Œ í•´ë‹¹)
            auth_tools = ["calendar_list_events", "calendar_create_event", "calendar_update_event", "calendar_delete_event", "calendar_get_event"]
            if name in auth_tools:
                from infra.core.auth_helpers import get_authenticated_user_id

                # ë„êµ¬ë³„ ì¸ì¦ í•„ë“œ ë§¤í•‘
                auth_fields = {                    "calendar_list_events": "user_id",                    "calendar_create_event": "user_id",                    "calendar_update_event": "user_id",                    "calendar_delete_event": "user_id",                    "calendar_get_event": "user_id",                }

                auth_field = auth_fields.get(name, "user_id")
                provided_user = arguments.get(auth_field)

                # ê³µí†µ í—¬í¼ ì ìš©
                resolved_user = get_authenticated_user_id(
                    {"user_id": provided_user} if provided_user else {},
                    authenticated_user_id,
                )

                # ë³´ì•ˆ ê²€ì¦ ë¡œê¹…
                if authenticated_user_id and provided_user and provided_user != authenticated_user_id:
                    logger.warning(
                        f"âš ï¸ ë³´ì•ˆ: ì¸ì¦ëœ user_id({authenticated_user_id})ì™€ íŒŒë¼ë¯¸í„° {auth_field}({provided_user})ê°€ ë‹¤ë¦„. ì¸ì¦ëœ user_id ì‚¬ìš©."
                    )

                if resolved_user:
                    arguments[auth_field] = resolved_user
            # Registryë¥¼ í†µí•œ ë„êµ¬ ì‹¤í–‰
            response = await self.registry.call_tool(
                name=name,
                arguments=arguments,
                authenticated_user_id=authenticated_user_id
            )

            # ì‘ë‹µ í¬ë§·íŒ…
            if hasattr(response, 'message'):
                return [TextContent(type="text", text=response.message)]
            elif hasattr(response, 'model_dump_json'):
                return [TextContent(type="text", text=response.model_dump_json(indent=2))]
            else:
                return [TextContent(type="text", text=str(response))]

        except ValueError as e:
            error_msg = str(e)
            logger.error(error_msg)
            return [
                TextContent(
                    type="text",
                    text=json.dumps(
                        {"success": False, "message": error_msg}, indent=2
                    ),
                )
            ]

        except Exception as e:
            logger.error(f"âŒ Tool ì‹¤í–‰ ì˜¤ë¥˜: {name}, {str(e)}", exc_info=True)
            error_response = {"success": False, "message": f"ì˜¤ë¥˜ ë°œìƒ: {str(e)}"}
            return [
                TextContent(type="text", text=json.dumps(error_response, indent=2))
            ]

    # ========================================================================
    # Helper: Convert to dict (for HTTP responses)
    # ========================================================================

    async def call_tool_as_dict(
        self,
        name: str,
        arguments: Dict[str, Any],
        authenticated_user_id: Optional[str] = None
    ) -> Dict[str, Any]:
        """
        HTTP APIìš© í—¬í¼: call_tool ê²°ê³¼ë¥¼ dictë¡œ ë°˜í™˜

        MCPëŠ” TextContentë¥¼ ë°˜í™˜í•˜ì§€ë§Œ,
        HTTP APIëŠ” JSON dictë¥¼ ë°˜í™˜í•´ì•¼ í•˜ë¯€ë¡œ ë³€í™˜ í—¬í¼ ì œê³µ
        """
        try:
            response = await self.registry.call_tool(
                name=name,
                arguments=arguments,
                authenticated_user_id=authenticated_user_id
            )

            if hasattr(response, 'model_dump'):
                return response.model_dump()
            elif hasattr(response, '__dict__'):
                return response.__dict__
            else:
                return {"result": str(response)}

        except Exception as e:
            logger.error(f"âŒ Tool ì‹¤í–‰ ì˜¤ë¥˜: {name}, {str(e)}", exc_info=True)
            raise