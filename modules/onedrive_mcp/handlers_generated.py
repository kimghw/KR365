"""
OneDrive File Management Service
MCP Protocol Handlers - Auto-generated from tool_config.yaml
Generated at: 2025-11-11T17:21:47.223768
Source config: modules/onedrive_mcp/tool_config.yaml

DO NOT EDIT THIS FILE DIRECTLY
Modify tool_config.yaml and regenerate using:
python scripts/generate_handlers.py --config modules/onedrive_mcp/tool_config.yaml
"""

import json
from typing import Any, Dict, List, Optional
from mcp.types import Tool, TextContent, Prompt, PromptArgument, PromptMessage

from infra.core.logger import get_logger
from infra.core.tool_registry import ToolRegistry, ToolConfig
from .onedrive_handler import OneDriveHandler
from .schemas import (    ListFilesRequest,    ListFilesResponse,    ReadFileRequest,    ReadFileResponse,    WriteFileRequest,    WriteFileResponse,    DeleteFileRequest,    DeleteFileResponse,)
logger = get_logger(__name__)


class OneDriveHandlers:
    """OneDrive File Management Service MCP Protocol Handlers"""

    def __init__(self):
        """Initialize handlers with tools instance and registry"""
        self.onedrive_handler = OneDriveHandler()
        self.registry = ToolRegistry()
        self._register_tools()
        logger.info("âœ… OneDriveHandlers initialized with 5 tools")

    def _register_tools(self):
        """Register all tools in the registry"""
        # list_files: OneDrive íŒŒì¼ ë° í´ë” ëª©ë¡ì„ ì¡°íšŒí•©ë‹ˆë‹¤. folder_pathë¥¼ ì§€ì •í•˜ë©´ í•´ë‹¹ í´ë”ì˜ íŒŒì¼ì„ ì¡°íšŒí•˜...
        self.registry.register(
            ToolConfig(
                name="list_files",
                description="OneDrive íŒŒì¼ ë° í´ë” ëª©ë¡ì„ ì¡°íšŒí•©ë‹ˆë‹¤. folder_pathë¥¼ ì§€ì •í•˜ë©´ í•´ë‹¹ í´ë”ì˜ íŒŒì¼ì„ ì¡°íšŒí•˜ê³ , searchë¥¼ ì§€ì •í•˜ë©´ ê²€ìƒ‰ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.",                request_class=ListFilesRequest,                response_class=ListFilesResponse,                method=self.onedrive_handler.list_files,                auth_required=True,                auth_field="user_id",                parameters=[{"description": "\uc0ac\uc6a9\uc790 ID (OPTIONAL - \uc138\uc158\uc5d0\uc11c \uc790\ub3d9 \ub9e4\ud551\ub428)", "name": "user_id", "required": False, "type": "string"}, {"description": "\ud3f4\ub354 \uacbd\ub85c (\uc608: Documents/MyFolder, \uc0dd\ub7b5 \uc2dc \ub8e8\ud2b8)", "name": "folder_path", "required": False, "type": "string"}, {"description": "\uac80\uc0c9\uc5b4", "name": "search", "required": False, "type": "string"}],            )
        )
        # read_file: OneDrive íŒŒì¼ì˜ ë‚´ìš©ì„ ì½ì–´ì˜µë‹ˆë‹¤. í…ìŠ¤íŠ¸ íŒŒì¼ì€ í…ìŠ¤íŠ¸ë¡œ, ë°”ì´ë„ˆë¦¬ íŒŒì¼ì€ Base64 ì¸ì½”ë”©ìœ¼ë¡œ ...
        self.registry.register(
            ToolConfig(
                name="read_file",
                description="OneDrive íŒŒì¼ì˜ ë‚´ìš©ì„ ì½ì–´ì˜µë‹ˆë‹¤. í…ìŠ¤íŠ¸ íŒŒì¼ì€ í…ìŠ¤íŠ¸ë¡œ, ë°”ì´ë„ˆë¦¬ íŒŒì¼ì€ Base64 ì¸ì½”ë”©ìœ¼ë¡œ ë°˜í™˜í•©ë‹ˆë‹¤.",                request_class=ReadFileRequest,                response_class=ReadFileResponse,                method=self.onedrive_handler.read_file,                auth_required=True,                auth_field="user_id",                parameters=[{"description": "\uc0ac\uc6a9\uc790 ID (OPTIONAL - \uc138\uc158\uc5d0\uc11c \uc790\ub3d9 \ub9e4\ud551\ub428)", "name": "user_id", "required": False, "type": "string"}, {"description": "\ud30c\uc77c \uacbd\ub85c \ub610\ub294 \ud30c\uc77c ID (\uc608: Documents/myfile.txt)", "name": "file_path", "required": True, "type": "string"}],            )
        )
        # write_file: OneDriveì— íŒŒì¼ì„ ìƒì„±í•˜ê±°ë‚˜ ë®ì–´ì”ë‹ˆë‹¤. ê¸°ë³¸ì ìœ¼ë¡œ ê¸°ì¡´ íŒŒì¼ì„ ë®ì–´ì“°ë©°, overwrite=fals...
        self.registry.register(
            ToolConfig(
                name="write_file",
                description="OneDriveì— íŒŒì¼ì„ ìƒì„±í•˜ê±°ë‚˜ ë®ì–´ì”ë‹ˆë‹¤. ê¸°ë³¸ì ìœ¼ë¡œ ê¸°ì¡´ íŒŒì¼ì„ ë®ì–´ì“°ë©°, overwrite=falseë¡œ ì„¤ì •í•˜ë©´ ë®ì–´ì“°ê¸°ë¥¼ ë°©ì§€í•©ë‹ˆë‹¤.",                request_class=WriteFileRequest,                response_class=WriteFileResponse,                method=self.onedrive_handler.write_file,                auth_required=True,                auth_field="user_id",                parameters=[{"description": "\uc0ac\uc6a9\uc790 ID (OPTIONAL - \uc138\uc158\uc5d0\uc11c \uc790\ub3d9 \ub9e4\ud551\ub428)", "name": "user_id", "required": False, "type": "string"}, {"description": "\ud30c\uc77c \uacbd\ub85c (\uc608: Documents/myfile.txt)", "name": "file_path", "required": True, "type": "string"}, {"description": "\ud30c\uc77c \ub0b4\uc6a9", "name": "content", "required": True, "type": "string"}, {"default": True, "description": "\uae30\uc874 \ud30c\uc77c \ub36e\uc5b4\uc4f0\uae30 \ud5c8\uc6a9 \uc5ec\ubd80", "name": "overwrite", "required": False, "type": "boolean"}],            )
        )
        # delete_file: OneDrive íŒŒì¼ ë˜ëŠ” í´ë”ë¥¼ ì‚­ì œí•©ë‹ˆë‹¤....
        self.registry.register(
            ToolConfig(
                name="delete_file",
                description="OneDrive íŒŒì¼ ë˜ëŠ” í´ë”ë¥¼ ì‚­ì œí•©ë‹ˆë‹¤.",                request_class=DeleteFileRequest,                response_class=DeleteFileResponse,                method=self.onedrive_handler.delete_file,                auth_required=True,                auth_field="user_id",                parameters=[{"description": "\uc0ac\uc6a9\uc790 ID (OPTIONAL - \uc138\uc158\uc5d0\uc11c \uc790\ub3d9 \ub9e4\ud551\ub428)", "name": "user_id", "required": False, "type": "string"}, {"description": "\ud30c\uc77c \ub610\ub294 \ud3f4\ub354 \uacbd\ub85c (\uc608: Documents/myfile.txt)", "name": "file_path", "required": True, "type": "string"}],            )
        )
        # create_folder: OneDriveì— ìƒˆ í´ë”ë¥¼ ìƒì„±í•©ë‹ˆë‹¤....
        self.registry.register(
            ToolConfig(
                name="create_folder",
                description="OneDriveì— ìƒˆ í´ë”ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.",                request_class=dict,                response_class=dict,                method=self.onedrive_handler.create_folder,                auth_required=True,                auth_field="user_id",                parameters=[{"description": "\uc0ac\uc6a9\uc790 ID (OPTIONAL - \uc138\uc158\uc5d0\uc11c \uc790\ub3d9 \ub9e4\ud551\ub428)", "name": "user_id", "required": False, "type": "string"}, {"description": "\uc0dd\uc131\ud560 \ud3f4\ub354 \uacbd\ub85c (\uc608: Documents/NewFolder)", "name": "folder_path", "required": True, "type": "string"}],            )
        )

    # ========================================================================
    # MCP Protocol: list_tools
    # ========================================================================

    async def handle_list_tools(self) -> List[Tool]:
        """List available MCP tools"""
        logger.info("ğŸ”§ [MCP Handler] list_tools() called")
        return self.registry.list_tools()

    # ========================================================================
    # MCP Protocol: call_tool
    # ========================================================================

    async def handle_call_tool(
        self,
        name: str,
        arguments: Dict[str, Any],
        authenticated_user_id: Optional[str] = None
    ) -> List[TextContent]:
        """Handle MCP tool calls"""
        logger.info(f"ğŸ”¨ [MCP Handler] call_tool({name}) with args: {arguments}")

        try:            # ì¸ì¦ ê¸°ë°˜ user_id ê°•ì œ ì ìš© (ê²€ìƒ‰ ê³„ì—´ íˆ´ì—ë§Œ í•´ë‹¹)
            auth_tools = ["list_files", "read_file", "write_file", "delete_file", "create_folder"]
            if name in auth_tools:
                from infra.core.auth_helpers import get_authenticated_user_id

                # ë„êµ¬ë³„ ì¸ì¦ í•„ë“œ ë§¤í•‘
                auth_fields = {                    "list_files": "user_id",                    "read_file": "user_id",                    "write_file": "user_id",                    "delete_file": "user_id",                    "create_folder": "user_id",                }

                auth_field = auth_fields.get(name, "user_id")
                provided_user = arguments.get(auth_field)

                # ê³µí†µ í—¬í¼ ì ìš©
                resolved_user = get_authenticated_user_id(
                    {"user_id": provided_user} if provided_user else {},
                    authenticated_user_id,
                )

                # ë³´ì•ˆ ê²€ì¦ ë¡œê¹…
                if authenticated_user_id and provided_user and provided_user != authenticated_user_id:
                    logger.warning(
                        f"âš ï¸ ë³´ì•ˆ: ì¸ì¦ëœ user_id({authenticated_user_id})ì™€ íŒŒë¼ë¯¸í„° {auth_field}({provided_user})ê°€ ë‹¤ë¦„. ì¸ì¦ëœ user_id ì‚¬ìš©."
                    )

                if resolved_user:
                    arguments[auth_field] = resolved_user
            # Registryë¥¼ í†µí•œ ë„êµ¬ ì‹¤í–‰
            response = await self.registry.call_tool(
                name=name,
                arguments=arguments,
                authenticated_user_id=authenticated_user_id
            )

            # ì‘ë‹µ í¬ë§·íŒ…
            if hasattr(response, 'message'):
                return [TextContent(type="text", text=response.message)]
            elif hasattr(response, 'model_dump_json'):
                return [TextContent(type="text", text=response.model_dump_json(indent=2))]
            else:
                return [TextContent(type="text", text=str(response))]

        except ValueError as e:
            error_msg = str(e)
            logger.error(error_msg)
            return [
                TextContent(
                    type="text",
                    text=json.dumps(
                        {"success": False, "message": error_msg}, indent=2
                    ),
                )
            ]

        except Exception as e:
            logger.error(f"âŒ Tool ì‹¤í–‰ ì˜¤ë¥˜: {name}, {str(e)}", exc_info=True)
            error_response = {"success": False, "message": f"ì˜¤ë¥˜ ë°œìƒ: {str(e)}"}
            return [
                TextContent(type="text", text=json.dumps(error_response, indent=2))
            ]

    # ========================================================================
    # Helper: Convert to dict (for HTTP responses)
    # ========================================================================

    async def call_tool_as_dict(
        self,
        name: str,
        arguments: Dict[str, Any],
        authenticated_user_id: Optional[str] = None
    ) -> Dict[str, Any]:
        """
        HTTP APIìš© í—¬í¼: call_tool ê²°ê³¼ë¥¼ dictë¡œ ë°˜í™˜

        MCPëŠ” TextContentë¥¼ ë°˜í™˜í•˜ì§€ë§Œ,
        HTTP APIëŠ” JSON dictë¥¼ ë°˜í™˜í•´ì•¼ í•˜ë¯€ë¡œ ë³€í™˜ í—¬í¼ ì œê³µ
        """
        try:
            response = await self.registry.call_tool(
                name=name,
                arguments=arguments,
                authenticated_user_id=authenticated_user_id
            )

            if hasattr(response, 'model_dump'):
                return response.model_dump()
            elif hasattr(response, '__dict__'):
                return response.__dict__
            else:
                return {"result": str(response)}

        except Exception as e:
            logger.error(f"âŒ Tool ì‹¤í–‰ ì˜¤ë¥˜: {name}, {str(e)}", exc_info=True)
            raise